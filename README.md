# Zapto.Mediator
Simple mediator implementation for Microsoft.Extensions.DependencyInjection.

This project is inspired by [MediatR](https://github.com/jbogard/MediatR). It uses [MediatR.Contracts](https://www.nuget.org/packages/MediatR.Contracts) so you can reuse all your contracts.

## Differences
Zapto.Mediator:

1. Only supports `Microsoft.Extensions.DependencyInjection`.
2. Requires you to specify types with `ISender.Send<TRequest, TResponse>(new TRequest())` to avoid boxing.  
   To make it easier you can use Zapto.Mediator.SourceGenerator to generate extension methods (e.g. `ISender.RequestAsync()`).
3. Does **not** support pipelines or generics (this is on the roadmap).
4. Allows you to use [C# 10 delegates](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-10.0/lambda-improvements).
5. Allows you to use request namespaces (multiple request handlers under a different namespace).
6. Uses `ValueTask` instead of `Task`.

## Benchmark
Note: [like MediatR](https://github.com/jbogard/MediatR.Extensions.Microsoft.DependencyInjection/blob/master/README.md), all handlers are registered as transient with the exception of delegate handlers.

### Single scope
This benchmark can be found in [benchmarks/Benchmarks/RequestBenchmark.cs](benchmarks/Benchmarks/RequestBenchmark.cs).

|         Method |      Mean |    Error |   StdDev |  Gen 0 | Allocated |
|--------------- |----------:|---------:|---------:|-------:|----------:|
|        MediatR | 515.64 ns | 3.732 ns | 3.491 ns | 0.0849 |   1,424 B |
|          Zapto |  51.68 ns | 0.142 ns | 0.126 ns | 0.0014 |      24 B |
|  ZaptoDelegate |  52.74 ns | 0.189 ns | 0.177 ns |      - |         - |
| ZaptoNamespace |  97.07 ns | 1.029 ns | 0.912 ns | 0.0086 |     144 B |

### Scoped
This benchmark can be found in [benchmarks/Benchmarks/ScopedRequestBenchmark.cs](benchmarks/Benchmarks/ScopedRequestBenchmark.cs).

|         Method |     Mean |   Error |  StdDev |  Gen 0 | Allocated |
|--------------- |---------:|--------:|--------:|-------:|----------:|
|        MediatR | 623.7 ns | 2.24 ns | 1.98 ns | 0.0992 |   1,664 B |
|          Zapto | 172.5 ns | 0.72 ns | 0.67 ns | 0.0200 |     336 B |
|  ZaptoDelegate | 181.6 ns | 0.81 ns | 0.76 ns | 0.0186 |     312 B |
| ZaptoNamespace | 221.1 ns | 0.62 ns | 0.58 ns | 0.0272 |     456 B |

## Example
```csharp
using MediatR;
using Zapto.Mediator;
using Microsoft.Extensions.DependencyInjection;

var services = new ServiceCollection();

// Add mediator
services.AddMediator();

// Add a request handler for "GetMessage"
services.AddRequestHandler((GetMessage _) => "Hello world");

// Add a notification handler for "WriteLineNotification"
services.AddNotificationHandler((WriteLineNotification notification) =>
{
    Console.WriteLine(notification.Message);
});

// Add a notification handler for "WriteLineNotification" with-in the mediator namespace "upper"
var upperNs = new MediatorNamespace("upper");

services.AddNotificationHandler((WriteLineNotification notification) =>
{
    Console.WriteLine(notification.Message.ToUpper());
}, upperNs);

// Create the service provider and execute the request and notifications
// Note that the extension methods 'GetMessageAsync' and 'WriteLineAsync' are generated by the source generator
await using var provider = services.BuildServiceProvider();

var mediator = provider.GetRequiredService<IMediator>();
var message = await mediator.GetMessageAsync();

await mediator.WriteLineAsync(message);
await mediator.WriteLineAsync(upperNs, message);

public record struct WriteLineNotification(string Message) : INotification;

public record struct GetMessage : IRequest<string>;
```

Result:
```
Hello world
HELLO WORLD
```